<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrega de OP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 10px;
            line-height: 1.4;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            font-size: 16px;
        }

        select, input[type="number"], textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background-color: white;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .conditional {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .conditional.show {
            display: block;
        }

        .payment-row {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            margin-bottom: 15px;
        }

        .payment-row .form-group {
            margin-bottom: 15px;
        }

        .payment-row .form-group:last-child {
            margin-bottom: 0;
        }

        .payment-row .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
            margin-top: 10px;
        }

        .add-payment {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 15px;
            width: 100%;
        }

        .submit-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            margin-top: 20px;
        }

        .submit-btn:hover {
            background-color: #0056b3;
        }

        .submit-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .required {
            color: red;
        }

        .summary {
            background-color: #e7f3ff;
            border: 2px solid #007bff;
            border-radius: 6px;
            padding: 15px;
            margin-top: 20px;
            display: none;
        }

        .summary h3 {
            margin-bottom: 10px;
            color: #007bff;
        }

        .summary-item {
            margin-bottom: 8px;
        }

        @media (min-width: 601px) {
            .payment-row {
                display: flex;
                gap: 10px;
                align-items: end;
            }

            .payment-row .form-group {
                margin-bottom: 0;
            }

            .payment-row .amount {
                flex: 1;
            }

            .payment-row .method {
                flex: 1;
            }

            .payment-row .remove-btn {
                height: 45px;
                white-space: nowrap;
                margin-top: 0;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ENTREGA DE OP</h1>
        
        <div id="loadingMessage" class="loading">
            Cargando datos del día...
        </div>
        
        <form id="deliveryForm" style="display:none;">
            <!-- Chofer -->
            <div class="form-group">
                <label for="chofer">Chofer: <span class="required">*</span></label>
                <select id="chofer" required>
                    <option value="">Seleccionar chofer...</option>
                </select>
            </div>

            <!-- OP -->
            <div class="form-group">
                <label for="op">OP: <span class="required">*</span></label>
                <select id="op" required disabled>
                    <option value="">Primero seleccione un chofer</option>
                </select>
            </div>

            <!-- Monto Total -->
            <div class="form-group" id="montoTotalGroup" style="display: none;">
                <label>Monto Total de la OP:</label>
                <div id="montoTotal" style="font-size: 18px; font-weight: bold; color: #007bff; padding: 10px; background: #f8f9fa; border-radius: 4px;">-</div>
            </div>

            <!-- ¿Qué monto se entregó? -->
            <div class="form-group">
                <label for="montoEntregado">¿Qué monto se entregó? <span class="required">*</span></label>
                <select id="montoEntregado" required>
                    <option value="">Seleccionar...</option>
                    <option value="todo">Todo</option>
                    <option value="parte">Una parte</option>
                    <option value="nada">Nada</option>
                </select>
            </div>

            <!-- Condicional: Una parte (entregado) -->
            <div id="entregadoParte" class="conditional">
                <div class="form-group">
                    <label for="montoEntregadoValor">Monto Entregado: <span class="required">*</span></label>
                    <input type="number" id="montoEntregadoValor" placeholder="Ejemplo: 300" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="motivoEntregadoParte">Motivo: <span class="required">*</span></label>
                    <textarea id="motivoEntregadoParte" placeholder="Ejemplo: No llevamos todos los productos" required></textarea>
                </div>
            </div>

            <!-- Condicional: Nada (entregado) -->
            <div id="entregadoNada" class="conditional">
                <div class="form-group">
                    <label for="motivoEntregadoNada">Motivo: <span class="required">*</span></label>
                    <textarea id="motivoEntregadoNada" placeholder="Escriba el motivo..." required></textarea>
                </div>
            </div>

            <!-- ¿Qué monto se cobró? -->
            <div class="form-group">
                <label for="montoCobrado">¿Qué monto se cobró? <span class="required">*</span></label>
                <select id="montoCobrado" required>
                    <option value="">Seleccionar...</option>
                    <option value="todo">Todo</option>
                    <option value="parte">Una parte</option>
                    <option value="nada">Nada</option>
                </select>
            </div>

            <!-- Condicional: Una parte (cobrado) -->
            <div id="cobradoParte" class="conditional">
                <div class="form-group">
                    <label for="montoCobradoValor">Monto Cobrado: <span class="required">*</span></label>
                    <input type="number" id="montoCobradoValor" placeholder="Ejemplo: 300" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="motivoCobradoParte">Motivo: <span class="required">*</span></label>
                    <textarea id="motivoCobradoParte" placeholder="Ejemplo: Cliente no tenía efectivo completo" required></textarea>
                </div>
            </div>

            <!-- Condicional: Nada (cobrado) -->
            <div id="cobradoNada" class="conditional">
                <div class="form-group">
                    <label for="motivoCobradoNada">Motivo: <span class="required">*</span></label>
                    <textarea id="motivoCobradoNada" placeholder="Escriba el motivo..." required></textarea>
                </div>
            </div>

            <!-- Comprobantes -->
            <div id="comprobantesSection" class="conditional">
                <h3 style="margin-bottom: 15px;">Comprobantes de Pago</h3>
                
                <div id="paymentsContainer"></div>
                
                <button type="button" class="add-payment" onclick="addPaymentRow()">
                    + Agregar Pago
                </button>

                <div id="paymentSummary" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; display: none;">
                    <strong>Total cobrado: S/<span id="totalCobrado">0</span></strong>
                    <div id="saldoPendiente" style="color: red; margin-top: 5px;"></div>
                </div>
            </div>

            <!-- Resumen antes de enviar -->
            <div id="summary" class="summary">
                <h3>Resumen del Formulario</h3>
                <div id="summaryContent"></div>
            </div>

            <button type="submit" class="submit-btn">Enviar Formulario</button>
        </form>
    </div>

    <script>
        const CONFIG = {
            SPREADSHEET_ID: '1Vbtp9sVYhJ5CcFgj9YbTJx_-WaRVuT6UWbg7CkFwLCE'
        };

        let choferesData = {};
        let paymentCounter = 0;
        let currentOPMonto = 0;

        // Cargar datos desde Google Sheets
        async function loadTodaysData() {
            try {
                const today = new Date();
                const todayStr = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
                
                document.getElementById('loadingMessage').textContent = `Cargando datos para ${todayStr}...`;
                
                const sheetUrl = `https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=input`;
                
                const response = await fetch(sheetUrl);
                const text = await response.text();
                const jsonText = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonText);
                
                const rows = data.table.rows;
                const todaysData = {};
                
                rows.forEach(row => {
                    const fechaValue = row.c[0]?.v;
                    const chofer = row.c[1]?.v;
                    const op = row.c[2]?.v;
                    const monto = row.c[3]?.v;
                    
                    if (fechaValue && chofer && op && monto) {
                        const dateMatch = fechaValue.match(/Date\\((\\d+),(\\d+),(\\d+)\\)/);
                        if (dateMatch) {
                            const year = parseInt(dateMatch[1]);
                            const month = parseInt(dateMatch[2]);
                            const day = parseInt(dateMatch[3]);
                            
                            const rowDate = new Date(year, month, day);
                            const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                            
                            if (rowDate.getTime() === todayDate.getTime()) {
                                if (!todaysData[chofer]) {
                                    todaysData[chofer] = [];
                                }
                                todaysData[chofer].push({
                                    op: op.toString(),
                                    monto: parseFloat(monto)
                                });
                            }
                        }
                    }
                });
                
                choferesData = todaysData;
                populateChoferesDropdown();
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('deliveryForm').style.display = 'block';
                
                console.log('Datos cargados para hoy:', todaysData);
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                
                choferesData = {
                    George: [{op: '123', monto: 1000}],
                    Jose: [{op: '456', monto: 850}]
                };
                populateChoferesDropdown();
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('deliveryForm').style.display = 'block';
            }
        }

        function populateChoferesDropdown() {
            const choferSelect = document.getElementById('chofer');
            choferSelect.innerHTML = '<option value="">Seleccionar chofer...</option>';
            
            Object.keys(choferesData).forEach(chofer => {
                const option = document.createElement('option');
                option.value = chofer.toLowerCase();
                option.textContent = chofer;
                choferSelect.appendChild(option);
            });
        }

        // Manejar selección de chofer
        document.getElementById('chofer').addEventListener('change', function() {
            const chofer = this.value;
            const choferName = this.selectedOptions[0]?.textContent || '';
            const opSelect = document.getElementById('op');
            
            opSelect.innerHTML = '<option value="">Seleccionar OP...</option>';
            document.getElementById('montoTotalGroup').style.display = 'none';
            
            if (chofer && choferesData[choferName]) {
                opSelect.disabled = false;
                choferesData[choferName].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.op;
                    option.textContent = item.op;
                    option.dataset.monto = item.monto;
                    opSelect.appendChild(option);
                });
            } else {
                opSelect.disabled = true;
                opSelect.innerHTML = '<option value="">Primero seleccione un chofer</option>';
            }
            
            resetForm();
        });

        // Manejar selección de OP
        document.getElementById('op').addEventListener('change', function() {
            const selectedOption = this.selectedOptions[0];
            if (selectedOption && selectedOption.dataset.monto) {
                currentOPMonto = parseFloat(selectedOption.dataset.monto);
                document.getElementById('montoTotal').textContent = `S/${currentOPMonto}`;
                document.getElementById('montoTotalGroup').style.display = 'block';
            } else {
                document.getElementById('montoTotalGroup').style.display = 'none';
                currentOPMonto = 0;
            }
            resetForm();
        });

        // Manejar condiciones para "monto entregado"
        document.getElementById('montoEntregado').addEventListener('change', function() {
            const value = this.value;
            document.getElementById('entregadoParte').classList.toggle('show', value === 'parte');
            document.getElementById('entregadoNada').classList.toggle('show', value === 'nada');
        });

        // Manejar condiciones para "monto cobrado"
        document.getElementById('montoCobrado').addEventListener('change', function() {
            const value = this.value;
            const entregaValue = document.getElementById('montoEntregado').value;
            
            document.getElementById('cobradoParte').classList.toggle('show', value === 'parte');
            document.getElementById('cobradoNada').classList.toggle('show', value === 'nada');
            
            const mostrarComprobantes = (entregaValue === 'todo' || entregaValue === 'parte') && 
                                      (value === 'todo' || value === 'parte');
            
            document.getElementById('comprobantesSection').classList.toggle('show', mostrarComprobantes);
            
            document.getElementById('paymentsContainer').innerHTML = '';
            paymentCounter = 0;
            
            if (mostrarComprobantes) {
                addPaymentRow();
            }
        });

        document.getElementById('montoEntregado').addEventListener('change', function() {
            const cobranzaEvent = new Event('change');
            document.getElementById('montoCobrado').dispatchEvent(cobranzaEvent);
        });

        function addPaymentRow() {
            paymentCounter++;
            const container = document.getElementById('paymentsContainer');
            
            const row = document.createElement('div');
            row.className = 'payment-row';
            row.id = `payment-${paymentCounter}`;
            
            const isFirst = container.children.length === 0;
            
            row.innerHTML = `
                <div class="form-group amount">
                    <label>Monto:</label>
                    <input type="number" name="paymentAmount[]" placeholder="100" min="0" step="0.01" required onchange="updatePaymentSummary()">
                </div>
                <div class="form-group method">
                    <label>Medio:</label>
                    <select name="paymentMethod[]" required>
                        <option value="">Seleccionar...</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="qr">QR</option>
                        <option value="transferencia">Transferencia</option>
                    </select>
                </div>
                ${!isFirst ? `<button type="button" class="remove-btn" onclick="removePaymentRow(${paymentCounter})">Eliminar</button>` : ''}
            `;
            
            container.appendChild(row);
            updatePaymentSummary();
        }

        function updatePaymentSummary() {
            const amounts = document.querySelectorAll('input[name="paymentAmount[]"]');
            let total = 0;
            
            amounts.forEach(input => {
                if (input.value && !isNaN(input.value)) {
                    total += parseFloat(input.value);
                }
            });
            
            document.getElementById('totalCobrado').textContent = total.toFixed(2);
            
            const summaryDiv = document.getElementById('paymentSummary');
            const saldoDiv = document.getElementById('saldoPendiente');
            
            if (total > 0) {
                summaryDiv.style.display = 'block';
                
                if (total < currentOPMonto) {
                    const saldo = currentOPMonto - total;
                    saldoDiv.textContent = `Saldo pendiente: S/${saldo.toFixed(2)}`;
                    saldoDiv.style.display = 'block';
                } else if (total > currentOPMonto) {
                    saldoDiv.textContent = `Exceso: S/${(total - currentOPMonto).toFixed(2)}`;
                    saldoDiv.style.color = 'orange';
                    saldoDiv.style.display = 'block';
                } else {
                    saldoDiv.style.display = 'none';
                }
            } else {
                summaryDiv.style.display = 'none';
            }
        }

        function removePaymentRow(id) {
            document.getElementById(`payment-${id}`).remove();
            updatePaymentSummary();
        }

        function resetForm() {
            document.getElementById('montoEntregado').value = '';
            document.getElementById('montoCobrado').value = '';
            document.querySelectorAll('.conditional').forEach(el => el.classList.remove('show'));
            document.getElementById('paymentsContainer').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            paymentCounter = 0;
        }

        function generateSummary() {
            const chofer = document.getElementById('chofer').selectedOptions[0]?.textContent || '';
            const op = document.getElementById('op').value;
            const montoTotal = currentOPMonto;
            const entrega = document.getElementById('montoEntregado').value;
            const cobranza = document.getElementById('montoCobrado').value;
            
            let html = `
                <div class="summary-item"><strong>Chofer:</strong> ${chofer}</div>
                <div class="summary-item"><strong>OP:</strong> ${op}</div>
                <div class="summary-item"><strong>Monto Total:</strong> S/${montoTotal}</div>
                <div class="summary-item"><strong>Entrega:</strong> ${entrega === 'todo' ? 'Completa' : entrega === 'parte' ? 'Incompleta' : 'No entregado'}</div>
                <div class="summary-item"><strong>Cobranza:</strong> ${cobranza === 'todo' ? 'Completa' : cobranza === 'parte' ? 'Incompleta' : 'No cobrado'}</div>
            `;
            
            const amounts = document.querySelectorAll('input[name="paymentAmount[]"]');
            const methods = document.querySelectorAll('select[name="paymentMethod[]"]');
            
            if (amounts.length > 0) {
                html += '<div class="summary-item"><strong>Pagos:</strong><ul style="margin-left: 20px;">';
                amounts.forEach((amount, i) => {
                    if (amount.value && methods[i].value) {
                        html += `<li>S/${amount.value} - ${methods[i].selectedOptions[0].textContent}</li>`;
                    }
                });
                html += '</ul></div>';
            }
            
            document.getElementById('summaryContent').innerHTML = html;
            document.getElementById('summary').style.display = 'block';
        }

        // Manejar envío del formulario
        document.getElementById('deliveryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            generateSummary();
            
            const submitBtn = document.querySelector('.submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';
            
            setTimeout(() => {
                alert('¡Formulario procesado correctamente!\\n\\n(Los datos se mostrarían en Google Sheets)');
                
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar Formulario';
            }, 1500);
        });

        // Inicializar aplicación
        document.addEventListener('DOMContentLoaded', function() {
            loadTodaysData();
        });
    </script>
</body>
</html>
